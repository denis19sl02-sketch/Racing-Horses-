<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Horse Jumping 3D</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<script>
let scene, camera, renderer;

// ===================== –î–í–ò–ñ–û–ö (–ë–ï–ó –†–ï–î–ê–ö–¢–û–†–ê) =====================
function initEngine() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // –¢–æ —Å–∞–º–æ–µ –≥–æ–ª—É–±–æ–µ –Ω–µ–±–æ

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // –û–°–í–ï–©–ï–ù–ò–ï –ö–ê–ö –í –û–†–ò–ì–ò–ù–ê–õ–ï
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(5, 10, 7);
    scene.add(dirLight);

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    initGame();
}

// ===================== –õ–û–ì–ò–ö–ê –¢–í–û–ï–ô –ò–ì–†–´ =====================
function initGame() {
    let gameData = JSON.parse(localStorage.getItem('horseGameSave')) || { 
        unlockedLevel: 1, 
        bestScore: 0, 
        selectedSkin: 'brown' 
    };
    const saveProgress = () => localStorage.setItem('horseGameSave', JSON.stringify(gameData));

    const sfxNeigh = new Audio('https://www.soundjay.com/nature/horse-neigh-1.mp3');
    const sfxGallop = new Audio('https://www.soundjay.com/nature/horse-gallop-1.mp3');
    const sfxWin = new Audio('https://cdn.freesound.org/previews/270/270402_5123851-lq.mp3'); 
    const sfxLose = new Audio('https://www.myinstants.com/media/sounds/mario-dies.mp3'); 
    sfxGallop.loop = true;

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playHoofStep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(120, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    const skins = {
        ginger: { body: 0xd35400, hair: 0xa04000 },
        white: { body: 0xfafafa, hair: 0xdddddd },
        brown: { body: 0x5d4037, hair: 0x221100 },
        spotted: { body: 0xffffff, hair: 0x333333, isSpotted: true },
        unicorn: { body: 0xfff0f5, hair: 0xff69b4, isUnicorn: true }
    };

    const horse = new THREE.Group();
    const bodyGroup = new THREE.Group();
    horse.add(bodyGroup);

    function applySkin() {
        bodyGroup.clear();
        const s = skins[gameData.selectedSkin];
        const hMat = new THREE.MeshStandardMaterial({color: s.body});
        const hairMat = new THREE.MeshStandardMaterial({color: s.hair});

        const b = new THREE.Mesh(new THREE.BoxGeometry(2.2, 2.5, 4.5), hMat); b.position.y = 3;
        const n = new THREE.Mesh(new THREE.BoxGeometry(0.9, 2.5, 1.2), hMat); n.position.set(0, 4.8, -1.8); n.rotation.x = 0.6;
        const h = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 2.2), hMat); h.position.set(0, 5.8, -2.8);
        const m = new THREE.Mesh(new THREE.BoxGeometry(0.5, 2.2, 1.2), hairMat); m.position.set(0, 5.2, -1.6);
        const t = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3.0, 0.5), hairMat); t.position.set(0, 3.2, 2.5); t.rotation.x = -0.5;

        if(s.isSpotted) {
            for(let i=0; i<8; i++) {
                const spot = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.15), new THREE.MeshStandardMaterial({color: 0x333333}));
                spot.position.set(1.11, 3 + (Math.random()-0.5)*1.5, (Math.random()-0.5)*3.5);
                bodyGroup.add(spot);
            }
        }
        if(s.isUnicorn) {
            const horn = new THREE.Mesh(new THREE.ConeGeometry(0.2, 1.5, 8), new THREE.MeshStandardMaterial({color: 0xffd700}));
            horn.position.set(0, 6.8, -3.2); horn.rotation.x = -0.3;
            bodyGroup.add(horn);
        }
        for(let i=0; i<4; i++) {
            const leg = new THREE.Mesh(new THREE.BoxGeometry(0.7, 2.2, 0.7), hMat);
            leg.position.set(i%2?1.1:-1.1, 1.1, i<2?2.0:-2.0);
            bodyGroup.add(leg);
        }
        bodyGroup.add(b, n, h, t, m);
    }
    horse.scale.set(1.3, 1.3, 1.3);
    applySkin();
    scene.add(horse);

    // –ü–†–ï–ñ–ù–Ø–Ø –ì–†–ê–§–ò–ö–ê –î–û–†–û–ì–ò (–¢–†–ê–í–´)
    const road = new THREE.Mesh(new THREE.PlaneGeometry(60, 5000), new THREE.MeshStandardMaterial({color: 0x2e7d32}));
    road.rotation.x = -Math.PI / 2; scene.add(road);

    const obstacles = [];
    function spawnObstacle(z) {
        const g = new THREE.Group();
        const wMat = new THREE.MeshStandardMaterial({color: 0x3e2723});
        const bar = new THREE.Mesh(new THREE.BoxGeometry(16, 1.2, 1.2), wMat); bar.position.y = 2.8;
        const p1 = new THREE.Mesh(new THREE.BoxGeometry(1.5, 6, 1.5), wMat); p1.position.set(7.5, 3, 0);
        const p2 = new THREE.Mesh(new THREE.BoxGeometry(1.5, 6, 1.5), wMat); p2.position.set(-7.5, 3, 0);
        g.add(bar, p1, p2); g.position.z = z; scene.add(g); obstacles.push(g);
    }
    for(let i=1; i<=10; i++) spawnObstacle(-i * 90);

    const ui = document.createElement('div');
    ui.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; font-family: 'Arial Black', sans-serif;";
    document.body.appendChild(ui);

    let gameMode = null, currentLevelGoal = 0, currentLevelNum = 0, gameActive = false;
    let speed = 0.8, score = 0, jumping = false, vY = 0, alive = true, stepTimer = 0;

    function showMenu() {
        gameActive = false; alive = false; sfxGallop.pause();
        ui.innerHTML = `
            <div style="width:100%; height:100%; background: rgba(0,0,0,0.5); display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; color:white;">
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <button id="btnSimple" style="width:120px; padding:10px; border-radius:10px; border:none; background:${gameMode === 'simple' ? '#00BFFF' : '#444'}; color:white; cursor:pointer;">SIMPLE</button>
                    <button id="btnLevels" style="width:120px; padding:10px; border-radius:10px; border:none; background:#00CED1; color:white; cursor:pointer;">LEVELS</button>
                    <button id="btnEndless" style="width:120px; padding:10px; border-radius:10px; border:none; background:${gameMode === 'endless' ? '#00BFFF' : '#444'}; color:white; cursor:pointer;">ENDLESS</button>
                </div>
                <button id="btnStart" style="width:335px; padding:25px; background:#1E90FF; color:white; border:none; border-radius:15px; font-size:28px; font-weight:bold; cursor:pointer; box-shadow: 0 8px #0056b3;">START</button>
                <button id="btnHome" style="width:335px; padding:15px; margin-top:20px; background:#4682B4; color:white; border:none; border-radius:10px; font-size:20px; cursor:pointer;">HOME (SKINS)</button>
            </div>
        `;
        document.getElementById('btnSimple').onclick = () => { gameMode = 'simple'; showMenu(); };
        document.getElementById('btnEndless').onclick = () => { gameMode = 'endless'; showMenu(); };
        document.getElementById('btnLevels').onclick = showLevelsMenu;
        document.getElementById('btnStart').onclick = () => { if(gameMode) startGame(); else alert('Select Mode!'); };
        document.getElementById('btnHome').onclick = showHomePage;
    }

    function showLevelsMenu() {
        let btns = "";
        for(let i=1; i<=35; i++) {
            const locked = i > gameData.unlockedLevel;
            btns += `<button id="lv${i}" style="width:55px; height:55px; margin:4px; border-radius:8px; border:none; background:${locked?'#333':'#1E90FF'}; color:white; cursor:${locked?'default':'pointer'}; opacity:${locked?0.5:1}; font-size:18px;">${locked?'üîí':i}</button>`;
        }
        ui.innerHTML = `
            <div style="width:100%; height:100%; background: rgba(0,0,0,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; color:white;">
                <h1 style="margin-bottom:15px;">LEVELS (1-35)</h1>
                <div style="display:flex; flex-wrap:wrap; justify-content:center; max-width:450px; margin-bottom:20px;">${btns}</div>
                <button id="btnLevelBack" style="width:200px; padding:15px; background:#444; color:white; border:none; border-radius:10px; cursor:pointer;">BACK</button>
            </div>
        `;
        for(let i=1; i<=35; i++) {
            const b = document.getElementById(`lv${i}`);
            if(b && i <= gameData.unlockedLevel) {
                b.onclick = () => {
                    gameMode = 'level';
                    currentLevelNum = i;
                    currentLevelGoal = i * 10;
                    startGame();
                };
            }
        }
        document.getElementById('btnLevelBack').onclick = showMenu;
    }

    function showHomePage() {
        ui.innerHTML = `
            <div style="width:100%; height:100%; background: rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; color:white;">
                <h1 style="color:#00BFFF; margin-bottom:5px;">STABLE</h1>
                <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:15px; text-align:center; margin-bottom:20px;">
                    <p style="margin:5px 0; font-size:22px; color:#FFD700;">üî• ENDLESS BEST: ${gameData.bestScore} JUMPS</p>
                    <p style="margin:5px 0; opacity:0.8;">üîì LEVELS CLEARED: ${gameData.unlockedLevel - 1}</p>
                </div>
                <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:25px;">
                    ${Object.keys(skins).map(s => `<button id="skin_${s}" style="padding:15px; background:${gameData.selectedSkin === s ? '#00BFFF' : '#444'}; color:white; border-radius:10px; border:none; cursor:pointer;">${s.toUpperCase()}</button>`).join('')}
                </div>
                <button id="btnBackHome" style="padding:15px 60px; background:#1E90FF; color:white; border-radius:10px; border:none; font-size:20px; font-weight:bold; cursor:pointer;">BACK</button>
            </div>
        `;
        Object.keys(skins).forEach(s => {
            document.getElementById(`skin_${s}`).onclick = () => { gameData.selectedSkin = s; saveProgress(); applySkin(); showHomePage(); };
        });
        document.getElementById('btnBackHome').onclick = showMenu;
    }

    function startGame() {
        obstacles.forEach((f, i) => { f.position.z = -(i + 1) * 90; });
        score = 0; speed = 0.8; alive = true; gameActive = true; jumping = false; horse.position.y = 0;
        ui.innerHTML = `<div id="sc" style="position:absolute; top:30px; left:30px; color:white; font-size:40px; font-weight:bold; text-shadow:3px 3px #1E90FF;">SCORE: 0 ${gameMode==='level'?'/ '+currentLevelGoal:''}</div>
            <button id="jb" style="position:absolute; bottom:50px; left:50%; transform:translateX(-50%); width:280px; height:120px; background:#1E90FF; border:6px solid #fff; border-radius:35px; color:white; font-size:50px; font-weight:bold; cursor:pointer; pointer-events:auto;">JUMP!</button>`;
        document.getElementById('jb').onpointerdown = (e) => { e.preventDefault(); if(!jumping && alive) { jumping = true; vY = 1.15; sfxNeigh.play(); } };
        sfxGallop.play(); loop();
    }

    function showResult(win) {
        gameActive = false; sfxGallop.pause();
        if(win) {
            sfxWin.play();
            if(gameMode === 'level' && currentLevelNum === gameData.unlockedLevel) { 
                gameData.unlockedLevel++; 
                saveProgress(); 
            }
        } else {
            sfxLose.play();
        }
        
        ui.innerHTML = `<div style="width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; pointer-events:auto; color:white;">
            <h1 style="color:#00BFFF; font-size:70px; text-align:center;">${win?'VICTORY! üèÜ':'GAME OVER üíÄ'}</h1>
            <button id="btnResBack" style="width:320px; padding:25px; background:#00BFFF; color:white; border-radius:15px; font-size:22px; font-weight:bold; cursor:pointer; border:none;">BACK TO MENU</button>
        </div>`;
        document.getElementById('btnResBack').onclick = showMenu;
    }

    function loop() {
        if(!alive || !gameActive) return;
        requestAnimationFrame(loop);
        stepTimer++;
        if(!jumping && stepTimer % 12 === 0) playHoofStep();
        road.position.z += speed; if(road.position.z > 500) road.position.z = 0;
        obstacles.forEach(f => {
            f.position.z += speed;
            if(f.position.z > -2.8 && f.position.z < 2.8 && horse.position.y < 2.5) {
                alive = false; 
                if(gameMode === 'endless' && score > gameData.bestScore) { gameData.bestScore = score; saveProgress(); }
                showResult(false);
            }
            if(f.position.z > 40) { 
                f.position.z = -860; score++; speed += 0.005; 
                document.getElementById('sc').innerText = "SCORE: " + score + (gameMode==='level'?' / '+currentLevelGoal:'');
                if(gameMode==='simple' && score>=10) showResult(true);
                if(gameMode==='level' && score>=currentLevelGoal) showResult(true);
            }
        });
        if(jumping) { horse.position.y += vY; vY -= 0.06; if(horse.position.y <= 0) { horse.position.y = 0; jumping = false; } }
        else { horse.position.y = Math.abs(Math.sin(Date.now()*0.015)) * 0.6; }
        renderer.render(scene, camera);
    }

    camera.position.set(0, 22, 45);
    camera.lookAt(0, 6, 0);
    showMenu();
}

window.addEventListener('load', initEngine);
</script>
</body>
</html>
